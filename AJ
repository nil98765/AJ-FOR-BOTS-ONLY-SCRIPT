local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")
local TeleportService = game:GetService("TeleportService")

local WEBHOOK_URL = "https://discord.com/api/webhooks/1442552537835114586/gCDBbiLiXfEzWVq-h3mNC0QIjuxq7-vfrDBOahYzH3cTVCB_XBRtxrpul16ICXL7DwEA"

local targetNames = {
    "Trenostruzzo Turbo 3000",
    "Odin Din Din Dun",
    "Tralalero Tralala",
    "Girafa Celestre",
    "Cocofanto Elefanto"
}

local alreadySent = {}

-- FIX: Add a cooldown for sending webhooks to avoid rate limits.
local lastWebhookTime = 0
local webhookCooldown = 10 -- Cooldown in seconds. Discord allows ~5 requests per 5 seconds, so 10 seconds is a safe interval.

local function isTargetName(name)
    for _, t in ipairs(targetNames) do
        if name == t then
            return true
        end
    end
    return false
end

-- MODIFIED: Added cooldown logic to prevent HTTP 429 errors.
local function sendWebhook(embed)
    local currentTime = tick()
    
    -- Check if enough time has passed since the last webhook.
    if currentTime - lastWebhookTime < webhookCooldown then
        print("Webhook on cooldown. Skipping send.")
        return -- Exit the function without sending the request.
    end

    local payload = HttpService:JSONEncode({embeds = {embed}})
    local r = syn and syn.request or http_request
    if r then
        local success, response = pcall(function()
            return r({
                Url = WEBHOOK_URL,
                Method = "POST",
                Headers = {["Content-Type"] = "application/json"},
                Body = payload
            })
        end)

        -- If the request was successful, update the last sent time.
        if success and response and response.Success ~= false then
            lastWebhookTime = currentTime
            print("Webhook sent successfully.")
        else
            print("Failed to send webhook. Reason:", response and response.StatusCode or "Unknown Error")
        end
    end
end

local function findTarget(model)
    for _, child in ipairs(model:GetChildren()) do
        if isTargetName(child.Name) then
            return child
        elseif child:IsA("Model") then
            local r = findTarget(child)
            if r then return r end
        end
    end
    return nil
end

-- MODIFIED: Now prefers servers with 4-5 players.
local function serverHop()
    local url = "https://games.roblox.com/v1/games/" .. game.PlaceId .. "/servers/Public?sortOrder=Asc&limit=100"
    local success, data = pcall(function()
        return HttpService:JSONDecode(game:HttpGet(url))
    end)

    if not success or not data or not data.data then
        warn("Failed to get server list for server hop.")
        return
    end

    -- First, try to find a server with the ideal player count (4-5 players)
    for _, s in ipairs(data.data) do
        if s.playing >= 4 and s.playing <= 5 and s.playing < s.maxPlayers and s.id ~= game.JobId then
            print("Found ideal server with " .. s.playing .. " players. Teleporting...")
            TeleportService:TeleportToPlaceInstance(game.PlaceId, s.id, Players.LocalPlayer)
            return -- Exit the function after initiating teleport
        end
    end

    -- If no ideal server was found, fall back to joining any non-full server
    print("No ideal servers found. Joining any available server...")
    for _, s in ipairs(data.data) do
        if s.playing < s.maxPlayers and s.id ~= game.JobId then
            print("Found fallback server with " .. s.playing .. " players. Teleporting...")
            TeleportService:TeleportToPlaceInstance(game.PlaceId, s.id, Players.LocalPlayer)
            return -- Exit the function after initiating teleport
        end
    end

    print("No other servers to hop to.")
end

while true do
    local foundAny = false
    local plots = workspace:FindFirstChild("Plots")

    if plots then
        for _, plot in ipairs(plots:GetChildren()) do
            local target = findTarget(plot)
            if target then
                foundAny = true
                -- CHANGED: Use the plot's full name as a key to be more unique.
                if not alreadySent[plot:GetFullName()] then
                    alreadySent[plot:GetFullName()] = true

                    local jobId = game.JobId
                    local placeId = game.PlaceId
                    local timestamp = os.date("!%Y-%m-%dT%H:%M:%SZ")
                    local playerCount = #Players:GetPlayers()

                    local teleportCode = 'game:GetService("TeleportService"):TeleportToPlaceInstance(' .. placeId .. ', "' .. jobId .. '", game.Players.LocalPlayer)'
                    local joinLink = "https://www.roblox.com/games/" .. placeId .. "?jobId=" .. jobId

                    local embed = {
                        title = "ðŸ¤– Auto Joiner Brainrot Found ðŸ¤–",
                        color = 0xFADA5E,
                        fields = {
                            {name = "ðŸ‘¥ People in Server", value = tostring(playerCount), inline = true},
                            {name = "ðŸ§  Brainrot Found", value = "```" .. target.Name .. "```"},
                            {name = "ðŸ”— Server JobId", value = "```" .. jobId .. "```"},
                            {name = "ðŸš€ Teleport", value = "```lua\n" .. teleportCode .. "\n```"},
                            {name = "ðŸŒ Join Link", value = "[Click to Join](" .. joinLink .. ")"},
                            {name = "ðŸ’» Credits", value = "nga_stfu and imnotbackyet"}
                        },
                        footer = {text = os.date("%Y-%m-%d %H:%M:%S")},
                        timestamp = timestamp
                    }

                    sendWebhook(embed)
                end
            end
        end
    end

    -- The script will server hop every 5 seconds.
    serverHop()

    task.wait(5)
end
