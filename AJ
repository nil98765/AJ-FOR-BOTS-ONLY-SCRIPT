task.spawn(function()
    local DEBUG = true
    local HttpService = game:GetService("HttpService")
    local Players = game:GetService("Players")
    local TeleportService = game:GetService("TeleportService")
    local Workspace = game:GetService("Workspace")
    local Player = Players.LocalPlayer

    local WEBHOOK_1M_10M = "https://discord.com/api/webhooks/1444263728446050455/iYXA8aaJOfWhlgCQ04YwW3vzraBAwIEvDi7-EdVgU--ACEXHktcwN69XuEarlVwD6ZR-"
    local WEBHOOK_10M_100M = "https://discord.com/api/webhooks/1444263853624918046/u2aeooCDow7VJnJ7kt8oGmylzWIIIIirbnse0VKs1EU_PZPiPUvW8duKk33Qh88xAIiU"
    local WEBHOOK_100M_400M = "https://discord.com/api/webhooks/1444263961573724180/8m_9-VsRfxaRU_D7LmUqIM4iVEKP_QlGSdvW1RiC4juu6tkfipBiC3Q-QSQnm4N4XU5_"
    local EXTRA_WEBHOOKS = {
        "https://discord.com/api/webhooks/...1",
        "https://discord.com/api/webhooks/...2"
    }

    local extraIndex = 1
    local WEBHOOK_COOLDOWN = 5
    local lastSent = {}
    local queue = {}
    local busy = false
    local scanned = {}
    local multipliers = { K=1e3, M=1e6, B=1e9, T=1e12, Q=1e15 }

    local function log(msg)
        if DEBUG then print("[BRAINROT] "..msg) end
    end

    local function getRequestFunction()
        return (syn and syn.request) or
               (http and http.request) or
               http_request or
               request or
               (fluxus and fluxus.request) or
               (krnl and krnl.request) or
               (wrap and wrap.request) or
               function(data)
                   if game and game.HttpGet and data.Method=="GET" then
                       local ok,res = pcall(game.HttpGet, game, data.Url)
                       return {Success=ok, Body=res}
                   elseif game and game.HttpPost and data.Method=="POST" then
                       local ok,res = pcall(game.HttpPost, game, data.Url, data.Body, Enum.HttpContentType.ApplicationJson)
                       return {Success=ok, Body=res}
                   end
                   return {Success=false, Body="No HTTP function"}
               end
    end

    local function getFallbackWebhook()
        local url = EXTRA_WEBHOOKS[extraIndex]
        extraIndex += 1
        if extraIndex > #EXTRA_WEBHOOKS then extraIndex = 1 end
        return url
    end

    local function QueueWebhook(url, payload)
        table.insert(queue, {Url=url, Payload=payload})
        if not busy then
            busy = true
            task.spawn(function()
                while #queue > 0 do
                    local item = table.remove(queue, 1)
                    local now = os.clock()
                    if lastSent[item.Url] and now - lastSent[item.Url] < WEBHOOK_COOLDOWN then
                        task.wait(WEBHOOK_COOLDOWN - (now - lastSent[item.Url]))
                    end
                    local req = getRequestFunction()
                    pcall(function()
                        req({
                            Url = item.Url,
                            Method = "POST",
                            Headers = {["Content-Type"] = "application/json"},
                            Body = item.Payload
                        })
                    end)
                    lastSent[item.Url] = os.clock()
                    task.wait(0.4)
                end
                busy = false
            end)
        end
    end

    local function formatNumber(num)
        local s = tostring(math.floor(num))
        while true do
            local f,k = s:gsub("^(-?%d+)(%d%d%d)", "%1,%2")
            s = f
            if k == 0 then break end
        end
        return s
    end

    local function parseMoney(str)
        if not str then return 0 end
        str = tostring(str):gsub("%$",""):gsub("/s",""):gsub("Generation",""):gsub("%s+","")
        local number,unit = str:match("([%d%.]+)(%a?)")
        if not number then return 0 end
        local n = tonumber(number) or 0
        local mult = multipliers[unit] or 1
        return n * mult
    end

    local function getAllBrainrots()
        local list = {}
        local plots = Workspace:FindFirstChild("Plots")
        if not plots then return list end
        for _, plot in ipairs(plots:GetChildren()) do
            for _, obj in ipairs(plot:GetDescendants()) do
                if obj.Name == "AnimalOverhead" then
                    local bb = obj.Parent
                    if bb then
                        local key = bb:GetFullName()
                        if not scanned[key] then
                            scanned[key] = true
                            local display = obj:FindFirstChild("DisplayName")
                            local gen = obj:FindFirstChild("Generation")
                            local displayName = display and (display.Text or display.Value) or "Unknown"
                            local genText = gen and (gen.Text or gen.Value) or "0"
                            local mps = parseMoney(genText)
                            if mps >= 1e6 then
                                table.insert(list, {
                                    Name = displayName,
                                    MPS = mps,
                                    GenRaw = genText
                                })
                            end
                        end
                    end
                end
            end
        end
        table.sort(list, function(a,b) return a.MPS > b.MPS end)
        return list
    end

    local function serverHop()
        local cursor = ""
        for _ = 1, 3 do
            local ok,data = pcall(function()
                return HttpService:JSONDecode(
                    game:HttpGet(
                        "https://games.roblox.com/v1/games/"..
                        game.PlaceId..
                        "/servers/Public?sortOrder=Asc&limit=100&cursor="..
                        cursor
                    )
                )
            end)
            if ok and data and data.data then
                for _, s in ipairs(data.data) do
                    if s.id ~= game.JobId then
                        local free = s.maxPlayers - s.playing
                        if free >= 2 then
                            log("Hopping â†’ "..s.id.." ("..s.playing.."/"..s.maxPlayers..")")
                            QueueWebhook(getFallbackWebhook(),
                                HttpService:JSONEncode({content="| Krypth at top | Notifier |"})
                            )
                            TeleportService:TeleportToPlaceInstance(
                                game.PlaceId,
                                s.id,
                                Player
                            )
                            return
                        end
                    end
                end
            end
            if not data.nextPageCursor then break end
            cursor = data.nextPageCursor
        end
    end

    task.spawn(function()
        local CoreGui = game:GetService("CoreGui")
        while true do
            local RobloxGui = CoreGui:FindFirstChild("RobloxGui")
            if RobloxGui then
                for _, gui in ipairs(RobloxGui:GetChildren()) do
                    if gui:IsA("ScreenGui") and gui.Name:match("Error") then
                        gui:Destroy()
                    end
                end
            end
            task.wait(0.3)
        end
    end)

    while true do
        local brainrots = getAllBrainrots()
        if #brainrots > 0 then
            local lines = {}
            for i, b in ipairs(brainrots) do
                local icon = (i==1 and "ðŸ‘‘") or (i==2 and "ðŸ¥ˆ") or (i==3 and "ðŸ¥‰") or "ðŸ’Ž"
                table.insert(lines, icon.." "..b.Name.." â€” "..b.GenRaw)
            end

            local best = brainrots[1]
            local webhookURL
            local ping = false

            if best.MPS < 1e7 then
                webhookURL = WEBHOOK_1M_10M
            elseif best.MPS < 1e8 then
                webhookURL = WEBHOOK_10M_100M
            elseif best.MPS <= 4e8 then
                webhookURL = WEBHOOK_100M_400M
                ping = true
            else
                webhookURL = getFallbackWebhook()
            end

            local joinLink =
                "https://chillihub1.github.io/chillihub-joiner/?placeId="..
                game.PlaceId..
                "&gameInstanceId="..
                game.JobId

            local embed = {
                title = string.format(
                    "1x %s ($%s/s)",
                    best.Name,
                    formatNumber(best.MPS)
                ),
                color = 0x2B2D31,
                fields = {
                    { name="ðŸŒ¿ Pet", value="```"..best.Name.." â€” "..best.GenRaw.."```" },
                    { name="ðŸ†” Server ID", value="```"..game.JobId.."```" },
                    {
                        name="ðŸ“œ Join Script",
                        value="```lua\n"..
                              "game:GetService(\"TeleportService\"):TeleportToPlaceInstance("..
                              game.PlaceId..", \""..game.JobId.."\", game.Players.LocalPlayer)\n```"
                    },
                    { name="ðŸ”— Join Link", value=joinLink },
                    { name="ðŸ¤– Bot", value="```"..(Player and Player.Name or "Unknown").."```" },
                    { name="ðŸ‘¥ Players", value="```"..#Players:GetPlayers().."/"..Players.MaxPlayers.."```" },
                    { name="ðŸ§± Brainrots", value="```"..table.concat(lines, "\n").."```" }
                },
                footer = { text = os.date("%Y-%m-%d %H:%M") },
                timestamp = os.date("!%Y-%m-%dT%H:%M:%SZ")
            }

            local payload =
                ping and HttpService:JSONEncode({content="@everyone", embeds={embed}})
                or HttpService:JSONEncode({embeds={embed}})

            QueueWebhook(webhookURL, payload)
        end

        task.wait(4)
        serverHop()
    end
end)
